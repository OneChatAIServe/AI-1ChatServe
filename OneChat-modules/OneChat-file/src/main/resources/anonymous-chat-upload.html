<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>åŒ¿åèŠå¤©é™„ä»¶ä¸Šä¼ ï¼ˆå¸¦ä¼šè¯è®¤è¯ + å®‰å…¨é¢„è§ˆï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        h2 {
            text-align: center;
            color: #1890ff;
        }
        .step {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:disabled {
            background: #bfbfbf;
            cursor: not-allowed;
        }
        .status {
            margin-top: 8px;
            font-size: 14px;
        }
        .success { color: #52c41a; }
        .error { color: #f5222d; }
        .upload-area {
            margin-top: 20px;
            padding: 20px;
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            text-align: center;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .preview {
            margin-top: 15px;
            text-align: center;
        }
        .preview img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #eee;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>

<h2>ğŸ’¬ åŒ¿åèŠå¤©é™„ä»¶ä¸Šä¼ ï¼ˆå®‰å…¨é¢„è§ˆï¼‰</h2>

<!-- æ­¥éª¤1ï¼šè¯†åˆ«è®¿å®¢ -->
<div class="step">
    <h3>1ï¸âƒ£ è¯†åˆ«è®¿å®¢èº«ä»½</h3>
    <button id="btnIdentify" onclick="identify()">è·å–è®¿å®¢èº«ä»½</button>
    <div id="statusIdentify" class="status"></div>
</div>

<!-- æ­¥éª¤2ï¼šåˆ›å»ºä¼šè¯ -->
<div class="step">
    <h3>2ï¸âƒ£ åˆ›å»ºä¼šè¯å‡­è¯</h3>
    <button id="btnSession" onclick="createSession()" disabled>åˆ›å»ºä¼šè¯ Token</button>
    <div id="statusSession" class="status"></div>
</div>

<!-- æ­¥éª¤3ï¼šä¸Šä¼ æ–‡ä»¶ -->
<div class="step upload-area">
    <h3>3ï¸âƒ£ ä¸Šä¼ é™„ä»¶</h3>
    <input type="file" id="fileInput" />
    <br />
    <button id="btnUpload" onclick="uploadFile()" disabled>ä¸Šä¼ æ–‡ä»¶</button>
    <div id="statusUpload" class="status"></div>

    <!-- å®‰å…¨é¢„è§ˆåŒº -->
    <div class="preview">
        <p>å®‰å…¨é¢„è§ˆï¼ˆéœ€ä¼šè¯ Tokenï¼‰ï¼š</p>
        <img id="securePreview" alt="é¢„è§ˆå›¾" />
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:5728';
    let sessionToken = null;

    async function identify() {
        updateStatus('statusIdentify', 'æ­£åœ¨è¯†åˆ«...', '');
        try {
            const res = await fetch(`${BASE_URL}/auth/identify`, {
                method: 'GET',
                credentials: 'include'
            });
            if (res.ok) {
                const data = await res.json();
                updateStatus('statusIdentify', `âœ… è®¿å®¢ID: ${data.data.visitor_id}`, 'success');
                document.getElementById('btnSession').disabled = false;
            } else {
                throw new Error(await res.text());
            }
        } catch (err) {
            updateStatus('statusIdentify', `âŒ ${err.message}`, 'error');
        }
    }

    async function createSession() {
        updateStatus('statusSession', 'æ­£åœ¨åˆ›å»ºä¼šè¯...', '');
        try {
            const res = await fetch(`${BASE_URL}/auth/session`, {
                method: 'POST',
                credentials: 'include'
            });
            if (res.ok) {
                const data = await res.json();
                sessionToken = data.data.session_token;
                updateStatus('statusSession', 'âœ… ä¼šè¯å‡­è¯å·²åˆ›å»º', 'success');
                document.getElementById('btnUpload').disabled = false;
            } else {
                throw new Error(await res.text());
            }
        } catch (err) {
            updateStatus('statusSession', `âŒ ${err.message}`, 'error');
        }
    }

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼');
            return;
        }

        updateStatus('statusUpload', 'æ­£åœ¨ä¸Šä¼ ...', '');
        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(`${BASE_URL}/file/chatUpload`, {
                method: 'POST',
                headers: {
                    'C-Auth-Token': 'Bearer ' + sessionToken
                },
                body: formData,
            });

            const result = await res.json();
            if (res.ok && result.code === 200) {
                const url = result.data.url;
                updateStatus('statusUpload', `âœ… ä¸Šä¼ æˆåŠŸï¼<br/>æ–‡ä»¶è·¯å¾„: ${url}`, 'success');

                // ğŸ‘‡ å°è¯•å®‰å…¨é¢„è§ˆï¼ˆä»…å½“æ˜¯å›¾ç‰‡æ—¶ï¼‰
                if (isImageUrl(url)) {
                    loadSecureImage(url);
                }
            } else {
                throw new Error(result.msg || 'ä¸Šä¼ å¤±è´¥');
            }
        } catch (err) {
            console.error('ä¸Šä¼ é”™è¯¯:', err);
            updateStatus('statusUpload', `âŒ ${err.message}`, 'error');
        }
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡ URL
    function isImageUrl(url) {
        const imgExts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
        const lowerUrl = url.toLowerCase();
        return imgExts.some(ext => lowerUrl.endsWith(ext));
    }

    // å®‰å…¨åŠ è½½å›¾ç‰‡ï¼ˆé€šè¿‡å¸¦ Token çš„ fetchï¼‰
    async function loadSecureImage(imageUrl) {
        const imgEl = document.getElementById('securePreview');
        imgEl.style.display = 'none'; // å…ˆéšè—

        try {
            // ç›´æ¥è¯·æ±‚åŸå§‹å›¾ç‰‡ URLï¼ˆå¦‚ http://localhost:5728/profile/upload/2025/.../abc.jpgï¼‰
            const res = await fetch(imageUrl, {
                method: 'GET',
                headers: {
                    'C-Auth-Token': 'Bearer ' + sessionToken
                }
            });

            if (!res.ok) {
                throw new Error('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + res.status);
            }

            const blob = await res.blob();
            const imgUrl = URL.createObjectURL(blob);
            imgEl.src = imgUrl;
            imgEl.style.display = 'inline-block';
        } catch (err) {
            console.error('å®‰å…¨é¢„è§ˆå¤±è´¥:', err);
            imgEl.alt = 'é¢„è§ˆå¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯');
            imgEl.style.display = 'inline-block';
        }
    }

    function updateStatus(id, message, type = '') {
        const el = document.getElementById(id);
        el.innerHTML = message;
        el.className = 'status ' + type;
    }
</script>

</body>
</html>